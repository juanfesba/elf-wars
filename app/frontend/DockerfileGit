# Stage 1: Build the React application
FROM node:alpine AS builder

# This sets the working directory inside the container to /app.
# All subsequent commands will run from this directory.
WORKDIR /src

# If you need git for cloning
RUN apk add --no-cache git

# 1. Fetch the latest commit info for your branch (replace 'main' if using a different branch)
ADD https://api.github.com/repos/juanfesba/elf-wars/commits/main /dev/null

# Clone your specific branch from your GitHub repository
# The code will be cloned into /app/frontend
RUN git clone https://github.com/juanfesba/elf-wars.git .

# Change the working directory to your frontend subdirectory within the cloned repo
# We navigate into the cloned repo folder, then into the frontend folder
WORKDIR /src/app/frontend

# This command runs npm to install all the project dependencies
# It will use the package.json in the current working directory (/app/elf-wars/frontend)
RUN npm install

# This executes the build script defined in your package.json
# It will build the app in the current directory, creating ./build
RUN npm run build

# --- Inspection Steps ---
# List the contents of the current directory after the build
## RUN ls -l
# List the contents of the expected build directory
## RUN ls -l build
# If ls build fails, try listing the contents of /app to see the overall structure
# RUN ls -l /app
# --- End Inspection Steps ---

# Stage 2: Serve the built application with a lightweight web server (like Nginx)
FROM nginx:stable-alpine

# Remove default nginx static assets
RUN rm -rf /usr/share/nginx/html/*

COPY --from=builder /src/app/frontend/nginx.conf.template /etc/nginx/templates/default.conf.template

# Copy the built files from the builder stage
# The build output will be located at /app/frontend/build
COPY --from=builder /src/app/frontend/dist /usr/share/nginx/html

# This specifies the command to run when the container starts
CMD ["/docker-entrypoint.sh", "nginx", "-g", "daemon off;"]